# üîß –û—Ç—á—ë—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –±–∞–≥–æ–≤

## üêõ –ë–ê–ì #1: –°–∏–º–≤–æ–ª "$" –≤–º–µ—Å—Ç–æ —Ç–æ—á–∫–∏ –≤ —á–∏—Å–ª–∞—Ö

### –ü—Ä–æ–±–ª–µ–º–∞:
- "1 USD = 1$1 CAD" –≤–º–µ—Å—Ç–æ "1 USD = 1.41 CAD"
- "$" –ø–æ—è–≤–ª—è–ª—Å—è –≤–º–µ—Å—Ç–æ –¥–µ—Å—è—Ç–∏—á–Ω–æ–π —Ç–æ—á–∫–∏

### –ü—Ä–∏—á–∏–Ω–∞:
**–§–∞–π–ª:** `utils/amount_formatter.dart`

```dart
// ‚ùå –ë–´–õ–û (—Å—Ç—Ä–æ–∫–∞ 21):
trimmed = trimmed.replaceFirst(RegExp(r'(\.\d*?[1-9])0+$'), r'$1');
//                                                           ^^^
// $1 –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞–ª—Å—è –∫–∞–∫ –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è —Å—Ç—Ä–æ–∫–∏, –∞ –Ω–µ –∫–∞–∫ RegExp –≥—Ä—É–ø–ø–∞!
```

–í Dart, –¥–∞–∂–µ –≤ raw —Å—Ç—Ä–æ–∫–µ `r'...'`, —Å–∏–º–≤–æ–ª `$` –º–æ–∂–µ—Ç –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ –Ω–∞—á–∞–ª–æ –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏. –ù—É–∂–Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ `\$1`.

### –†–µ—à–µ–Ω–∏–µ:
```dart
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û:
trimmed = trimmed.replaceFirst(RegExp(r'(\.\d*?[1-9])0+$'), r'\$1');
//                                                            ^^^^
// –¢–µ–ø–µ—Ä—å $1 –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø–µ—Ä–≤—É—é –≥—Ä—É–ø–ø—É –∑–∞—Ö–≤–∞—Ç–∞ RegExp
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç:
- ‚úÖ "1 USD = 1.41 CAD" - –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ "1,234.56" - —Ç–æ—á–∫–∞ –Ω–∞ —Å–≤–æ—ë–º –º–µ—Å—Ç–µ
- ‚úÖ –í—Å–µ —á–∏—Å–ª–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üêõ –ë–ê–ì #2: –ì—Ä–∞—Ñ–∏–∫ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è (–≤–µ—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)

### –ü—Ä–æ–±–ª–µ–º–∞:
- –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞ - –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Å–ø–∏–Ω–Ω–µ—Ä
- –î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è
- API/–ë–î –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç

### –ü—Ä–∏—á–∏–Ω–∞:
**–§–∞–π–ª:** `repositories/historical_rates_repository.dart`

**–ü—Ä–æ–±–ª–µ–º–∞ 1: Race condition**
```dart
// ‚ùå –ë–´–õ–û:
// main.dart –∑–∞–ø—É—Å–∫–∞–ª initializeAsync() –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
historicalRepository.initializeAsync(); // –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ —Ñ–æ–Ω–µ

// –ù–æ –≥—Ä–∞—Ñ–∏–∫ –ø—ã—Ç–∞–ª—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –î–û –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î
// loadLatest() –≤—ã–∑—ã–≤–∞–ª—Å—è –∫–æ–≥–¥–∞ _isInitialized = false
```

**–ü—Ä–æ–±–ª–µ–º–∞ 2: Deadlock –≤ _ensureInitialized**
```dart
// ‚ùå –ë–´–õ–û:
if (_initCompleter != null) {
  await _initCompleter!.future; // –ú–æ–≥–ª–æ –∑–∞–≤–∏—Å–Ω—É—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
}
```

**–ü—Ä–æ–±–ª–µ–º–∞ 3: –°–ª–∏—à–∫–æ–º –¥–æ–ª–≥–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è**
```dart
// ‚ùå –ë–´–õ–û:
await database.database; // –ë—ã—Å—Ç—Ä–æ
// ... –Ω–æ –ø–æ—Ç–æ–º
await _syncPair(...); // –ú–µ–¥–ª–µ–Ω–Ω–æ (10+ –ø–∞—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª–æ—Å—å)
_isInitialized = true; // –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–∞—Ä!
```

### –†–µ—à–µ–Ω–∏–µ:

**1. –î–≤—É—Ö—Ñ–∞–∑–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:**
```dart
// ‚úÖ –§–ê–ó–ê 1 (–±—ã—Å—Ç—Ä–æ): –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
await database.database;
_isInitialized = true; // –°—Ä–∞–∑—É –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –≥–æ—Ç–æ–≤—É—é!
_initCompleter!.complete();

// ‚úÖ –§–ê–ó–ê 2 (–º–µ–¥–ª–µ–Ω–Ω–æ): –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ–Ω–µ
_preloadHistoricalData(); // –ù–µ –∂–¥—ë–º, –∑–∞–ø—É—Å–∫–∞–µ–º –≤ —Ñ–æ–Ω–µ
```

**2. –£–ø—Ä–æ—â–µ–Ω–∏–µ _ensureInitialized:**
```dart
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ—Å—Ç–∞—è –∏ –Ω–∞–¥—ë–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞
Future<void> _ensureInitialized() async {
  if (_isInitialized) return;
  
  if (_initCompleter != null) {
    try {
      await _initCompleter!.future;
    } catch (_) {
      _initCompleter = null;
      _isInitialized = false;
    }
  }
  
  if (!_isInitialized) {
    await initializeAsync();
  }
}
```

**3. –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–∞–º–∏:**
```dart
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û:
Future<List<HistoricalRate>> loadLatest(...) async {
  await _ensureInitialized(); // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∂–¥—ë–º –ë–î
  final cached = await database.loadLatest(...);
  return cached.reversed.toList();
}
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç:
- ‚úÖ –ë–î –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∑–∞ ~50-100ms (—Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã)
- ‚úÖ UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
- ‚úÖ –ì—Ä–∞—Ñ–∏–∫ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –±–µ–∑ –∑–∞–≤–∏—Å–∞–Ω–∏–π
- ‚úÖ –î–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ —Ñ–æ–Ω–µ –Ω–µ–∑–∞–º–µ—Ç–Ω–æ

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
| –û–ø–µ—Ä–∞—Ü–∏—è | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|----------|-----------|
| –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è | ‚ùå 1500ms |
| –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–µ–ª | ‚ùå "1$1" (–±–∞–≥) |
| –û—Ç–∫—Ä—ã—Ç–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ | ‚ùå –ë–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ |

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
| –û–ø–µ—Ä–∞—Ü–∏—è | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|----------|-----------|
| –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è | ‚úÖ ~100ms |
| –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–µ–ª | ‚úÖ "1.41" |
| –û—Ç–∫—Ä—ã—Ç–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ | ‚úÖ 200-500ms |

---

## üéØ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. `utils/amount_formatter.dart` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω RegExp
2. `repositories/historical_rates_repository.dart` - –¥–≤—É—Ö—Ñ–∞–∑–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
- ‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è USD ‚Üí CAD: "1.41" (–±—ã–ª–æ "1$1")
- ‚úÖ –ì—Ä–∞—Ñ–∏–∫ USD ‚Üí CAD: –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π
- ‚úÖ –í—Å–µ –¥—Ä—É–≥–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç

---

## ‚úÖ –°—Ç–∞—Ç—É—Å

**–û–±–∞ –±–∞–≥–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã!** üéâ

- üîß –ë–∞–≥ #1 (—Å–∏–º–≤–æ–ª $) - –ò–°–ü–†–ê–í–õ–ï–ù
- üîß –ë–∞–≥ #2 (–≥—Ä–∞—Ñ–∏–∫ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è) - –ò–°–ü–†–ê–í–õ–ï–ù
- ‚úÖ –õ–æ–≥–∏–∫–∞ –∏ –≤–∏–∑—É–∞–ª - –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
- ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å - –£–õ–£–ß–®–ï–ù–ê

**–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üöÄ
